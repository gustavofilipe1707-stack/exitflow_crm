<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExitFlow | Core Management v1.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #05070a;
            --panel: #0d1117;
            --neon: #00d4ff;
            --text: #f1f5f9;
            --border: #1e293b;
            --danger: #ff4d4d;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        /* LOGIN */
        #login-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 40px;
            border-radius: 12px;
            width: 350px;
            text-align: center;
        }

        /* HEADER */
        header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-link-ef {
            color: #8b949e;
            cursor: pointer;
            font-weight: 600;
            margin-right: 20px;
            transition: 0.3s;
            padding: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .nav-link-ef.active {
            color: var(--neon);
            border-bottom: 2px solid var(--neon);
        }

        /* CONTENT */
        .ef-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            height: 100%;
        }

        /* HEALTH MONITOR */
        .health-tag {
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .status-ok {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-err {
            background: rgba(255, 77, 77, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* CALENDÁRIO */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .cal-day {
            background: #161b22;
            border: 1px solid var(--border);
            aspect-ratio: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .cal-day.active {
            border: 2px solid var(--neon);
            background: rgba(0, 212, 255, 0.1);
        }

        .has-ev {
            width: 6px;
            height: 6px;
            background: var(--neon);
            border-radius: 50%;
            margin-top: 3px;
        }

        /* FORM ELEMENTS */
        .env-selector {
            background: #161b22;
            color: var(--neon);
            border: 1px solid var(--neon);
            border-radius: 5px;
            padding: 5px 15px;
            font-weight: bold;
            outline: none;
        }

        input,
        select {
            background: #05070a !important;
            border: 1px solid var(--border) !important;
            color: white !important;
            padding: 10px !important;
            margin-bottom: 10px;
            border-radius: 6px !important;
            width: 100%;
        }

        .btn-neon {
            background: var(--neon);
            color: #000;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--neon); letter-spacing: 2px;">EXITFLOW</h2>
            <p class="text-secondary small mb-4">Core Management Portal</p>
            <input type="text" id="user" placeholder="Usuário">
            <input type="password" id="pass" placeholder="Senha">
            <button class="btn-neon" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <div id="portal" class="hidden">
        <header>
            <div class="fw-bold" style="color: var(--neon);">EXITFLOW <span class="text-white fw-light">PRO</span></div>
            <nav>
                <span class="nav-link-ef active" id="nav-dash" onclick="showTab('dash')">MONITORAMENTO</span>
                <span class="nav-link-ef" id="nav-cal" onclick="showTab('cal')">AGENDA POC</span>
                <span class="nav-link-ef" id="nav-cli" onclick="showTab('cli')">CLIENTES</span>
            </nav>
            <div class="d-flex align-items-center gap-3">
                <select class="env-selector" id="env-select" onchange="switchEnvironment()">
                    <option value="saidagaia">POLO GAIA (Default)</option>
                    <option value="polo_teste">POLO TESTE</option>
                </select>
                <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">SAIR</button>
            </div>
        </header>

        <main class="p-4">
            <div id="tab-dash" class="tab-content">
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="ef-card d-flex gap-4 align-items-center py-2">
                            <span class="small text-secondary">SAÚDE DO SISTEMA:</span>
                            <div><small>CONEXÃO:</small> <span id="health-db"
                                    class="health-tag status-err">OFFLINE</span></div>
                            <div><small>LATÊNCIA:</small> <span id="health-ping" class="health-tag status-ok">--
                                    ms</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="ef-card text-center">
                            <small class="text-secondary">FILA ATUAL</small>
                            <h2 id="count-waiting" class="text-warning">0</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="ef-card text-center">
                            <small class="text-secondary">ENTREGUES HOJE</small>
                            <h2 id="count-delivered" class="text-success">0</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="ef-card text-center">
                            <small class="text-secondary">AMBIENTE ATIVO</small>
                            <h2 id="current-env-label" style="color: var(--neon); font-size: 1.5rem;">GAIA</h2>
                        </div>
                    </div>
                </div>
                <div class="ef-card">
                    <h5>Chamadas em Tempo Real</h5>
                    <div class="table-responsive mt-3">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th>ALUNO</th>
                                    <th>SALA</th>
                                    <th>RESPONSÁVEL</th>
                                    <th>CHEGADA</th>
                                </tr>
                            </thead>
                            <tbody id="realtime-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-cal" class="tab-content hidden">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="ef-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Agenda de Atividades</h5>
                                <button class="btn btn-sm btn-outline-info" onclick="openModal('modalEv')">+ NOVO
                                    EVENTO</button>
                            </div>
                            <div class="cal-grid" id="gridCal"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="ef-card">
                            <h6 id="calTitle">Selecione um dia</h6>
                            <hr class="border-secondary">
                            <div id="calEventsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-cli" class="tab-content hidden">
                <div class="ef-card">
                    <div class="d-flex justify-content-between mb-4">
                        <h5>Gestão de Clientes</h5>
                        <button class="btn btn-sm btn-outline-info" onclick="openModal('modalCli')">+ NOVO
                            CLIENTE</button>
                    </div>
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>ESCOLA</th>
                                <th>GESTOR</th>
                                <th>CONTATO</th>
                                <th>E-MAIL</th>
                                <th>AÇÃO</th>
                            </tr>
                        </thead>
                        <tbody id="cliBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="modalEv" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary p-4">
                <h6 id="dateLabel">Novo Evento</h6>
                <input type="text" id="ev-emp" placeholder="Instituição">
                <input type="text" id="ev-ass" placeholder="Tipo de Atividade">
                <button class="btn-neon" onclick="saveEv()">SALVAR</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCli" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary p-4">
                <h6>Cadastrar Cliente</h6>
                <input type="text" id="c-nom" placeholder="Nome da Escola">
                <input type="text" id="c-res" placeholder="Responsável">
                <input type="text" id="c-tel" placeholder="WhatsApp">
                <input type="text" id="c-mai" placeholder="E-mail">
                <button class="btn-neon" onclick="saveCli()">CADASTRAR</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const environments = {
            saidagaia: { url: "https://saidagaia-default-rtdb.firebaseio.com", label: "GAIA" },
            polo_teste: { url: "https://saidagaia-default-rtdb.firebaseio.com", label: "TESTE" }
        };

        let database = null;
        let selDate = null;
        let localDB = {
            evs: JSON.parse(localStorage.getItem('ef_evs')) || {},
            cli: JSON.parse(localStorage.getItem('ef_cli')) || []
        };

        function login() {
            if (document.getElementById('user').value.toLowerCase() === "gustavo.filipe" && document.getElementById('pass').value === "1234") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('portal').classList.remove('hidden');
                initFirebase('saidagaia');
            } else alert("Credenciais Incorretas");
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.nav-link-ef').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('nav-' + id).classList.add('active');
            if (id === 'cal') renderCalendar();
            if (id === 'cli') renderClients();
        }

        function initFirebase(envKey) {
            const config = {
                apiKey: "AIzaSyBDdVksMaItsqib7g2wIye78q70q0KK3fk",
                authDomain: "saidagaia.firebaseapp.com",
                databaseURL: environments[envKey].url,
                projectId: "saidagaia"
            };
            if (firebase.apps.length) firebase.app().delete();
            firebase.initializeApp(config);
            database = firebase.database();
            document.getElementById('current-env-label').innerText = environments[envKey].label;
            startApp();
        }

        function switchEnvironment() { initFirebase(document.getElementById('env-select').value); }

        function startApp() {
            const hoje = new Date().toLocaleDateString().replace(/\//g, '-');

            // Monitor de Conexão Ativa
            database.ref(".info/connected").on("value", snap => {
                const el = document.getElementById('health-db');
                el.innerText = snap.val() ? "ONLINE" : "OFFLINE";
                el.className = snap.val() ? "health-tag status-ok" : "health-tag status-err";
            });

            // Teste de Latência Real (Ping)
            setInterval(() => {
                const start = Date.now();
                database.ref(".info/serverTimeOffset").once("value").then(() => {
                    const latency = Date.now() - start;
                    const pingEl = document.getElementById('health-ping');
                    pingEl.innerText = latency + " ms";
                    pingEl.className = latency > 300 ? "health-tag status-err" : "health-tag status-ok";
                });
            }, 5000);

            // Fila do Firebase (Monitoramento)
            database.ref('fila/').orderByChild('data').equalTo(hoje).on('value', snap => {
                const data = snap.val() || {};
                let w = 0, d = 0, html = "";
                Object.keys(data).reverse().forEach(id => {
                    const item = data[id];
                    if (item.status === 'aguardando') {
                        w++;
                        html += `<tr><td><b>${item.aluno}</b></td><td>${item.serie}</td><td>${item.responsavel}</td><td>${new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td></tr>`;
                    } else d++;
                });
                document.getElementById('count-waiting').innerText = w;
                document.getElementById('count-delivered').innerText = d;
                document.getElementById('realtime-body').innerHTML = html || '<tr><td colspan="4" class="text-center text-secondary">Aguardando novos chamados...</td></tr>';
            });
        }

        // AGENDA
        function renderCalendar() {
            const g = document.getElementById('gridCal'); g.innerHTML = "";
            for (let i = 1; i <= 28; i++) {
                let key = `2026-02-${i < 10 ? '0' + i : i}`;
                let has = localDB.evs[key] && localDB.evs[key].length > 0;
                let div = document.createElement('div');
                div.className = `cal-day ${selDate === key ? 'active' : ''}`;
                div.innerHTML = `<span>${i}</span>${has ? '<div class="has-ev"></div>' : ''}`;
                div.onclick = () => { selDate = key; document.getElementById('dateLabel').innerText = "Novo Evento: " + key; renderCalendar(); showEvents(); };
                g.appendChild(div);
            }
        }

        function showEvents() {
            const evs = localDB.evs[selDate] || [];
            document.getElementById('calTitle').innerText = "Agenda: " + (selDate || "Selecione");
            document.getElementById('calEventsList').innerHTML = evs.length ? evs.map(e => `<div class="p-2 mb-2 bg-dark border-start border-info"><b>${e.emp}</b><br><small>${e.ass}</small></div>`).join('') : "Nada agendado.";
        }

        function saveEv() {
            const emp = document.getElementById('ev-emp').value, ass = document.getElementById('ev-ass').value;
            if (!emp || !selDate) return;
            if (!localDB.evs[selDate]) localDB.evs[selDate] = [];
            localDB.evs[selDate].push({ emp, ass });
            localStorage.setItem('ef_evs', JSON.stringify(localDB.evs));
            bootstrap.Modal.getInstance(document.getElementById('modalEv')).hide();
            document.getElementById('ev-emp').value = ""; document.getElementById('ev-ass').value = "";
            renderCalendar(); showEvents();
        }

        // CLIENTES
        function renderClients() {
            const b = document.getElementById('cliBody'); b.innerHTML = "";
            localDB.cli.forEach((c, idx) => {
                b.innerHTML += `<tr><td>${c.n}</td><td>${c.r}</td><td>${c.t}</td><td>${c.m}</td><td><i class="bi bi-trash text-danger" style="cursor:pointer" onclick="delCli(${idx})"></i></td></tr>`;
            });
        }

        function saveCli() {
            const n = document.getElementById('c-nom').value, r = document.getElementById('c-res').value, t = document.getElementById('c-tel').value, m = document.getElementById('c-mai').value;
            if (!n) return;
            localDB.cli.push({ n, r, t, m });
            localStorage.setItem('ef_cli', JSON.stringify(localDB.cli));
            bootstrap.Modal.getInstance(document.getElementById('modalCli')).hide();
            renderClients();
        }

        function delCli(i) { localDB.cli.splice(i, 1); localStorage.setItem('ef_cli', JSON.stringify(localDB.cli)); renderClients(); }
        function openModal(id) { new bootstrap.Modal(document.getElementById(id)).show(); }
    </script>
</body>

</html>